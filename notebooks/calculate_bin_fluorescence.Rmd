---
title: "Calculate bin fluorescence"
author: "Jaeda Patton"
date: "7/19/2022"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=5)

# check for packages and install any that are missing
packages <- c("flowCore")
installed_packages <- packages %in% rownames(installed.packages())
if(any(installed_packages == F)) {
  install.packages(packages[!installed_packages])
}
# load packages
invisible(lapply(packages, library, character.only=TRUE))

# make output directory
if(!dir.exists(file.path("..", "results", "sort_bin_fluorescence"))) {
  dir.create(file.path("..", "results", "sort_bin_fluorescence"))
}
```


This notebook reads in flow cytometry data from the binned sorting experiments and calculates the mean fluorescence for each sort bin and sample, for both libraries and isogenic control samples. It also calculates the overall mean fluorescence for each sample from flow cytometry data. 

FCS files for each sample were exported from FACSDiva after sorting and analyzed in FlowJo. Gates were drawn in FlowJo based on recorded bin boundary coordinates to replicate the gates used for sorting. In addition to the sort gates, we included gates selecting for homogenous cell populations, single cells, and DBD plasmid retention, as shown in sorting worksheets. Sort bin populations were then exported as FCS files for analysis here.


## Functions

First, we create a function to extract normalized GFP fluorescence values from FCS files. GFP fluorescence is recorded in the FITC channel. We assume FSC-A to be proportional to the area of the cross section of a cell, and normalize GFP by cell volume by taking $\textrm{FITC-A} / \textrm{FSC-A}^{1.5}$. We then take the log-10 of this value as the fluorescence measurement.

```{r}
extract_GFP <- function(fcs_dir, GFPfluor = 'FITC', norm_method = 1.5) {
  
  # extract FCS data
  fcs <- flowCore::read.FCS(fcs_dir)
  data <- flowCore::exprs(fcs)
  
  # extract GFP fluroescence from the FITC-A channel
  GFP <- data[, grepl(GFPfluor, colnames(data)) & grepl('-A', colnames(data))]
  FSC_A <- data[, 'FSC-A']
  
  # remove cells that are at the upper and lower bounds of the FSC-A range
  filter_out <- (FSC_A == 2 ^ 18 - 1) | (GFP <= 0)
  GFP <- GFP[!filter_out]
  FSC_A <- FSC_A[!filter_out]
  
  # normalize by FSC_A^norm_method
  # norm_method=1.5 normalizes GFP to cell volume (default)
  # norm_method=1 normalizes GFP to cell surface area
  norm_GFP <- log(GFP / FSC_A^norm_method, 10)
  
  return(norm_GFP)
}
```


## Reading in data

We will now read in the flow cytometry data from the sort bin populations.

```{r}
# read in FCS files for sort rep 1
# paths to FCS files
fcs_dir <- list.files(file.path("..", "data", "flow_cytometry", "binned_sort_rep1"), 
                      pattern='.+\\.fcs', full.names=TRUE)

# sample/bin names
fcs_names <- gsub(paste0(file.path("..", "data", "flow_cytometry", "binned_sort_rep1"), "[/\\\\]"), "", fcs_dir)
fcs_names <- gsub("export_Sample_", "", fcs_names)
fcs_names <- gsub('_[[:digit:]]+', '', fcs_names)
fcs_names <- gsub('.fcs', '', fcs_names)
```


## Calculating mean fluorescence

We will now calculate the mean fluorescence for each sort bin and sample, as well as the mean fluorescence for each sample across sort bins. These will be stored in a data frame.

```{r}
# calculate mean fluorescence for each bin and sample
# first, define sample names
samples <- sapply(fcs_names, strsplit, '_bin ')
samples <- sapply(samples, `[`, 1)
samples <- unique(samples)

# Create data frame to store mean fluorescence values.
# Rows are samples. The first four columns are the mean fluorescence for each
# sort bin; the last column ("total") is the mean fluorescence across all sort bins.
mean_F <- as.data.frame(matrix(rep(NA, length(samples)*5), nrow=length(samples), ncol=5))
rownames(mean_F) <- samples
colnames(mean_F) <- c(1:4, 'total')

for(i in 1:length(fcs_dir)) {
  sample_bin <- unlist(strsplit(fcs_names[i], '_bin '))
  GFP <- extract_GFP(fcs_dir[i])
  mean_F[rownames(mean_F)==sample_bin[1], sample_bin[2]] <- mean(GFP)
}

# calculate mean fluorescence for each sample
for(i in 1:length(samples)) {
  fcs_dir_sample <- fcs_dir[grepl(samples[i], fcs_names, fixed=TRUE)]
  GFP <- c()
  for(j in 1:length(fcs_dir_sample)) {
    GFP <- c(GFP, extract_GFP(fcs_dir_sample[j]))
  }
  mean_F[rownames(mean_F)==samples[i], 5] <- mean(GFP)
}

# write results to a table
write.table(mean_F, file.path("..", "results", "sort_bin_fluorescence", "binned_sort_rep_1_FACS_fluorescence.txt"), sep='\t')
```


## QC checks

We'll check the mean library fluorescence over the course of the sorting experiment to check for fluorescence drift.

```{r}
# rep 1

# mean GFP of library samples
full_lib_mean_F <- mean_F[grepl('full_lib', rownames(mean_F)), 5]

# use GFP-null and GFP-saturated isogenic strains to bound the y-axis of the plot
null_mean_F <- mean_F[grepl('null', rownames(mean_F)), 5]
sat_mean_F <- mean_F[grepl('sat', rownames(mean_F)), 5]

plot(x=1:5, y=full_lib_mean_F, xlab='hr', ylab='mean library fluorescence', ylim=c(null_mean_F, sat_mean_F))
```

Looks like library fluorescence decreased slightly over the course of sorting, but very little compared to the dynamic range.

